"use strict";function xhrPack(method="get",url,spec,callback={}){callback.onSuccess||(callback.onSuccess=function(response){console.info(response)}),callback.onProgress||(callback.onProgress=function(response){console.warn(response)}),callback.onFail||(callback.onFail=function(response){console.error(response)});let xhr=null;if(["get","post","put","delete"].indexOf(method.toLowerCase())<0)throw new Error(lang.methodInvalid.replace("$1",method.toUpperCase()));return xhr=new XMLHttpRequest,spec&&(spec.credentials&&(xhr.withCredentials=!0),spec.responseType&&(xhr.responseType=spec.responseType)),xhr.open(method,url),xhr.onreadystatechange=function(){if(4!=this.readyState)callback.onProgress({state:this.readyState});else if(this.status>199&&this.status<300){let rep={state:this.readyState,response:this.response,type:this.responseType,status:this.status.toString(),json:null};try{this.response.constructor==String&&(rep.text=this.responseText)}catch(error){console.error("Response is not text.")}try{this.response.constructor==String&&(rep.xml=this.responseXML)}catch(error){console.error("Response is not XML.")}try{this.response.constructor==String&&(rep.json=JSON.parse(rep.text))}catch(error){console.error("Response is not JSON.")}callback.onSuccess(rep)}else callback.onFail({state:this.readyState,status:this.status.toString()})},xhr.send(),xhr}chrome.webRequest.onBeforeSendHeaders.addListener(function(details){console.info("Grabbed a request from [$1]".replace("$1",details.url));let noReferer=!0,noOrigin=!0;return details.requestHeaders.forEach(e=>{"Referer"==e.name?(noReferer=!1,console.warn("Referer header is contained in this request.")):"Origin"==e.name&&(noOrigin=!1,console.warn("Origin header is contained in this request."))}),-1!=details.url.indexOf("-hz")?(console.info("This video is a normal one."),noReferer&&(console.warn("No Referer header is contained in this request.\nAdding..."),details.requestHeaders.push({name:"Referer",value:"https://www.bilibili.com/video/"})),noOrigin&&(console.warn("No Origin header is contained in this request.\nAdding..."),details.requestHeaders.push({name:"Origin",value:"https://www.bilibili.com/"}))):(console.info("This video is from bangumi."),noReferer&&(console.warn("No Referer header is contained in this request.\nAdding..."),details.requestHeaders.push({name:"Referer",value:"https://www.bilibili.com/bangumi/play"})),noOrigin&&(console.warn("No Origin header is contained in this request.\nAdding..."),details.requestHeaders.push({name:"Origin",value:"https://www.bilibili.com/"}))),console.log("Request headers have been edited.\n%o",details.requestHeaders),{requestHeaders:details.requestHeaders}},{urls:["*://*.acgvideo.com/*"]},["requestHeaders","blocking"]),self.search={},search.qq=function(word,page=1,number=20,successCallback,errorCallback=function(object){console.error(object)}){return xhrPack("get","https://c.y.qq.com/soso/fcgi-bin/client_search_cp?p=$1&n=$2&w=$3&format=json&loginUin=0&hostUin=0&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0&remoteplace=txt.yqq.song&t=0&aggr=1&cr=1&catZhida=1&flag_qc=0)".replace("$1",page).replace("$2",number).replace("$3",word),{credentials:!0},{onSuccess:function(data){successCallback(data.json.data.song.list)},onFail:function(data){console.error(data)}})},search.bilibili=function(word,page,successCallback,errorCallback=function(object){console.error(object)}){xhrPack("get","https://search.bilibili.com/all?keyword=$1&page=$2".replace("$1",word).replace("$2",page),{credentials:!0},{onSuccess:function(data){}})},search.bilibili.Bangumi=function(seasonId,name){this.season=seasonId,this.name=name},self.media={},media.quality={AUTO:-1,FAST:0,COMMON:1,NORMAL:1,HIGH:2,ULTRA:3,LOSSLESS:3,P360:16,P480:32,P720:64,P1080:80,PAUTO:0},media.qq=function(mid,quality=media.quality.AUTO,successCallback,errorCallback=function(object){console.error(object)}){chrome.cookies.getAll({domain:".qq.com"},function(cookies){let loginUin=-1,shortUin=-1,guid=0;cookies.forEach(function(e){switch(e.name){case"pgv_pvid":guid=parseInt(e.value);break;case"ptui_loginuin":loginUin=parseInt(e.value),shortUin=e.value%8192}});let data={req:{module:"CDN.SrfCdnDispatchServer",method:"GetCdnDispatch",param:{guid:guid.toString(),calltype:0,userip:""}},req_0:{module:"vkey.GetVkeyServer",method:"CgiGetVkey",param:{guid:guid.toString(),songmid:[mid],songtype:[0],uin:loginUin.toString(),loginflag:1,platform:"20"}},comm:{uin:loginUin,format:"json",ct:24,cv:0}};xhrPack("get","https://u.y.qq.com/cgi-bin/musicu.fcg?-=getplaysongvkey&loginUin=$1&hostUin=0&format=json&inCharset=utf8&outCharset=utf-8&notice=0&platform=y.qq.json&needNewCode=0&data=$2".replace("$1",loginUin.toString()).replace("$2",encodeURIComponent(JSON.stringify(data))),{credentials:!0},{onSuccess:function(data){let vkey=data.json.req_0.data.midurlinfo[0].vkey,streamingAddress=data.json.req_0.data.sip[Math.floor(2*Math.random())];0==quality?(streamingAddress+=data.json.req_0.data.midurlinfo[0].filename,streamingAddress+="?guid=$3&vkey=$1&uin=$2&fromtag=66".replace("$1",vkey).replace("$2",shortUin).replace("$3",guid)):1==quality?(streamingAddress+="M500"+mid+".mp3",streamingAddress+="?guid=$3&vkey=$1&uin=$2&fromtag=1".replace("$1",vkey).replace("$2",shortUin).replace("$3",guid)):2==quality?(streamingAddress+="M800"+mid+".mp3",streamingAddress+="?guid=$3&vkey=$1&uin=$2&fromtag=33".replace("$1",vkey).replace("$2",shortUin).replace("$3",guid)):3==quality&&(streamingAddress+="F000"+mid+".flac",streamingAddress+="?guid=$3&vkey=$1&uin=$2&fromtag=33".replace("$1",vkey).replace("$2",shortUin).replace("$3",guid)),successCallback(streamingAddress)},onFail:function(){console.error("Failed to get song VKEY.")}})})},media.bilibili={},media.bilibili.bangumi=function(aid,cid,epid,quality=media.PAUTO,successCallback,errorCallback=function(object){console.error(object)}){xhrPack("get","https://api.bilibili.com/pgc/player/web/playurl?avid=$1&cid=$2&type=&otype=json&ep_id=$3&qn=$4".replace("$1",aid).replace("$2",cid).replace("$3",epid).replace("$4",quality),{credentials:!0},{onSuccess:function(data){successCallback(data.json.result.durl)}})},media.bilibili.video=function(aid,quality=media.PAUTO,successCallback,errorCallback=function(object){console.error(object)}){xhrPack("get","https://www.bilibili.com/video/av"+aid,{},{onSuccess:function(data){let tempDocument=(new DOMParser).parseFromString(data.text,"text/html"),cid=JSON.parse(tempDocument.getElementsByTagName("script")[3].innerText.replace("window.__INITIAL_STATE__=","").replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")).videoData.cid;xhrPack("get","https://api.bilibili.com/x/player/playurl?avid=$1&cid=$2&qn=$3".replace("$1",aid).replace("$2",cid).replace("$3",quality),{credentials:!0},{onSuccess:function(response){successCallback(response.json.data.dash)}})}})},self.episodes={},episodes.bilibili=function(sid,successCallback,errorCallback=function(object){console.error(object)}){xhrPack("get","https://bangumi.bilibili.com/web_api/get_ep_list?season_id=$1&season_type=1".replace("$1",sid),{credentials:!0},{onSuccess:function(data){successCallback(data.json.result)}})};